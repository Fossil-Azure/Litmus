<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Litmus Image Selector</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    select, input, textarea, button {
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      max-width: 400px;
    }
    img {
      max-width: 200px;
      display: block;
      margin-top: 10px;
    }
    .card {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Litmus Image Selector</h2>

  <label for="sheetSelect">Select Sheet:</label>
  <select id="sheetSelect" onchange="loadItems()"></select>

  <label for="skuSelect">Search SKU:</label>
  <select id="skuSelect" onchange="populateSelected()" style="width: 100%;"></select>

  <div id="selectedImage"></div>

  <label for="emailInput">Email(s):</label>
  <textarea id="emailInput" placeholder="Enter emails separated by comma"></textarea>

  <label for="urlInput">URL(s):</label>
  <textarea id="urlInput" placeholder="Enter URLs separated by comma"></textarea>

  <button onclick="submitForm()">Submit</button>

  <div class="card" id="cardContainer"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwtRABTPiTS70--ZH0Tu6SaivW5TUijR8vZv_iYfzLg9L1UO9gLAtycDSCqEiVT811xxw/exec"; // Replace with your deployed Web App URL
    let allData = [];

    function fetchSheets() {
      fetch(`${scriptURL}?meta=true`)
        .then(res => res.json())
        .then(sheets => {
          const sheetSelect = document.getElementById("sheetSelect");
          sheetSelect.innerHTML = "";
          sheets.forEach(sheet => {
            let option = document.createElement("option");
            option.value = sheet;
            option.textContent = sheet;
            sheetSelect.appendChild(option);
          });
          loadItems(); // Load data for first sheet
        });
    }

    function loadItems() {
      const sheet = document.getElementById("sheetSelect").value;
      fetch(`${scriptURL}?sheet=${sheet}`)
        .then(res => res.json())
        .then(data => {
          allData = data;
          const skuSelect = document.getElementById("skuSelect");
          skuSelect.innerHTML = "<option disabled selected>Select SKU</option>";
          data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.SKU;
            option.textContent = `${item.SKU} (${item.Brand})`;
            skuSelect.appendChild(option);
          });
        })
        .catch(err => {
          alert("Could not load items. Make sure your script is deployed as Web App and shared publicly.");
          console.error(err);
        });
    }

    function populateSelected() {
      const sku = document.getElementById("skuSelect").value;
      const selected = allData.find(item => item.SKU === sku);
      if (!selected) return;

      document.getElementById("emailInput").value = selected.Email || "";
      document.getElementById("urlInput").value = selected.Url || "";

      const imageDiv = document.getElementById("selectedImage");
      imageDiv.innerHTML = selected.Image
        ? `<img src="${selected.Image}" alt="Selected Image">`
        : "No image found.";

      document.getElementById("cardContainer").innerHTML = `
        <strong>Brand:</strong> ${selected.Brand}<br>
        <strong>Campaign:</strong> ${selected.Campaign}<br>
        <strong>Start Date:</strong> ${selected["Start Date"]}<br>
        <strong>Expiry Date:</strong> ${selected["Expiry Date"]}<br>
        <strong>Contract End Date:</strong> ${selected["Contract End Date"]}<br>
        <strong>Expiry Status:</strong> ${selected["Expiry Status"]}<br>
        <strong>Contract Status:</strong> ${selected["Contract Status"]}<br>
        <strong>Status:</strong> ${selected.Status}
      `;
    }

    function submitForm() {
      const sheet = document.getElementById("sheetSelect").value;
      const sku = document.getElementById("skuSelect").value;
      const email = document.getElementById("emailInput").value;
      const url = document.getElementById("urlInput").value;

      if (!sku || !email) {
        alert("Please select an SKU and enter at least one email.");
        return;
      }

      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sheet, sku, email, url })
      })
      .then(res => res.text())
      .then(response => {
        alert("Submitted successfully!");
        loadItems();
      })
      .catch(err => {
        alert("Error submitting: " + err);
        console.error(err);
      });
    }

    fetchSheets(); // Initialize on load
  </script>

</body>
</html>
