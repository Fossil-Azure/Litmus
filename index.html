<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Litmus Sheet Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; }
    img { max-width: 100px; display: block; }
    #previewImage { max-width: 200px; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Litmus Sheet Viewer</h2>

  <label for="sheetSelect">Select Sheet:</label>
  <select id="sheetSelect"></select>

  <br><br>

  <label for="skuSelect">Select SKU:</label>
  <select id="skuSelect"></select>

  <div id="previewImageContainer"></div>

  <br>

  <label for="emailInput">Enter Email(s):</label>
  <input type="text" id="emailInput" placeholder="Separate multiple with commas">

  <br><br>

  <label for="urlInput">Enter URL(s):</label>
  <input type="text" id="urlInput" placeholder="Separate multiple with commas">

  <br><br>

  <button onclick="submitForm()">Submit</button>

  <div id="resultMessage"></div>

  <h3>Items</h3>
  <div id="itemsContainer"></div>

  <script>
  const API_URL = 'https://corsproxy.io/?https://script.google.com/macros/s/AKfycbzUgYpWDN66BHYAUFLK8KC-d42hpcu4Y-afc_3qPZHIq7NWky5cYduHc3j-SwGBIAS5Fg/exec';

    let allData = [];
    let currentSheet = "";

    async function fetchSheets() {
      try {
        const res = await fetch(API_URL + '?meta=true');
        const sheets = await res.json();
        const sheetSelect = document.getElementById("sheetSelect");
        sheets.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sheetSelect.appendChild(opt);
        });
        currentSheet = sheets[0];
        loadItems(currentSheet);
        sheetSelect.addEventListener("change", e => {
          currentSheet = e.target.value;
          loadItems(currentSheet);
        });
      } catch (err) {
        console.error("Error fetching sheets:", err);
        document.getElementById("resultMessage").textContent = "Could not load sheets.";
      }
    }

    async function loadItems(sheetName) {
      try {
        const res = await fetch(`${API_URL}?sheet=${sheetName}`);
        const data = await res.json();
        allData = data;
        populateSKUSelect(data);
        displayCards(data);
      } catch (err) {
        console.error("Error loading items:", err);
        document.getElementById("resultMessage").textContent = "Could not load items.";
      }
    }

    function populateSKUSelect(data) {
      const skuSelect = document.getElementById("skuSelect");
      skuSelect.innerHTML = '';
      data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.SKU;
        opt.textContent = `${item.SKU} - ${item.Brand}`;
        skuSelect.appendChild(opt);
      });
      skuSelect.addEventListener("change", updatePreview);
      updatePreview();
    }

    function updatePreview() {
      const sku = document.getElementById("skuSelect").value;
      const item = allData.find(d => d.SKU === sku);
      const preview = document.getElementById("previewImageContainer");
      if (item && item.Image) {
        preview.innerHTML = `<img id="previewImage" src="${item.Image}" alt="Preview">`;
      } else {
        preview.innerHTML = "";
      }

      document.getElementById("emailInput").value = item?.Email || "";
      document.getElementById("urlInput").value = item?.Url || "";
    }

    async function submitForm() {
      const sheet = currentSheet;
      const sku = document.getElementById("skuSelect").value;
      const email = document.getElementById("emailInput").value;
      const url = document.getElementById("urlInput").value;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sheet, sku, email, url })
        });
        const text = await res.text();
        document.getElementById("resultMessage").textContent = text;
        loadItems(sheet); // refresh
      } catch (err) {
        console.error("Submit failed:", err);
        document.getElementById("resultMessage").textContent = "Error submitting.";
      }
    }

    function displayCards(data) {
      const container = document.getElementById("itemsContainer");
      container.innerHTML = "";
      data.forEach(item => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <strong>Brand:</strong> ${item.Brand}<br>
          <strong>SKU:</strong> ${item.SKU}<br>
          <strong>Campaign:</strong> ${item.Campaign}<br>
          <strong>Email:</strong> ${item.Email || "N/A"}<br>
          <strong>URL:</strong> ${item.Url || "N/A"}<br>
          ${item.Image ? `<img src="${item.Image}">` : ""}
        `;
        container.appendChild(div);
      });
    }

    fetchSheets();
  </script>

</body>
</html>
